name: Pull Request Validation

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Pull Request
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 bandit safety
      
      - name: Security scan with Bandit
        run: |
          echo "Running security checks..."
          bandit -r . -ll -f json -o bandit-report.json || true
          bandit -r . -ll
        continue-on-error: true
      
      - name: Check dependencies for vulnerabilities
        run: |
          echo "Checking for vulnerable dependencies..."
          safety check --json || true
          safety check
        continue-on-error: true
      
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,__pycache__,.git
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --exclude=venv,__pycache__,.git --statistics
      
      - name: Check for secrets
        run: |
          echo "Checking for hardcoded secrets..."
          if grep -r "DISCORD_TOKEN.*=.*['\"]" --include="*.py" --exclude-dir=venv .; then
            echo "âŒ Found hardcoded Discord tokens!"
            exit 1
          fi
          echo "âœ“ No secrets found"
      
      - name: Check Python imports
        run: |
          python -c "
          import importlib.util
          import sys
          
          modules = ['bot', 'config', 'database', 'market', 'market_simulator', 'team_detection', 'utils', 'graphing']
          failed = []
          
          for m in modules:
              if importlib.util.find_spec(m) is None:
                  failed.append(m)
                  print(f'âŒ Cannot import {m}')
              else:
                  print(f'âœ“ {m}')
          
          if failed:
              print(f'\nFailed to import: {failed}')
              sys.exit(1)
          print('\nAll modules OK!')
          "
      
      - name: Validate config structure
        run: |
          python -c "
          import config
          
          required = ['TEAMS', 'TEAM_TAGS', 'SPURS_PER_COG', 'MARKET_UPDATE_INTERVAL']
          missing = [attr for attr in required if not hasattr(config, attr)]
          if missing:
              print(f'Missing config: {missing}')
              exit(1)
          
          assert len(config.TEAMS) > 0, 'No teams defined'
          
          for symbol, team in config.TEAMS.items():
              required_keys = ['name', 'symbol', 'starting_price', 'volatility', 'role_name']
              missing_keys = [k for k in required_keys if k not in team]
              if missing_keys:
                  print(f'Team {symbol} missing: {missing_keys}')
                  exit(1)
          
          print('Config validation passed!')
          "
      
      - name: Test database initialization
        run: |
          python -c "
          import asyncio
          import os
          import database
          
          async def test():
              original_path = database.config.DB_PATH
              database.config.DB_PATH = 'test_economy.db'
              
              try:
                  await database.init_db()
                  print('âœ“ Database initialization successful')
                  
                  success = await database.register_player(12345)
                  assert success
                  print('âœ“ Player registration works')
                  
                  success = await database.register_player(12345)
                  assert not success
                  print('âœ“ Duplicate registration blocked')
                  
                  print('\nDatabase tests passed!')
              finally:
                  database.config.DB_PATH = original_path
                  if os.path.exists('test_economy.db'):
                      os.remove('test_economy.db')
          
          asyncio.run(test())
          "
      
      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
        continue-on-error: true
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ¤– Automated Code Review\n\n';
            
            if (fs.existsSync('bandit-report.json')) {
              const bandit = JSON.parse(fs.readFileSync('bandit-report.json'));
              const issues = bandit.results || [];
              
              if (issues.length > 0) {
                comment += '### âš ï¸ Security Issues Found\n\n';
                issues.slice(0, 5).forEach(issue => {
                  comment += `- **${issue.test_name}** (${issue.issue_severity})\n`;
                  comment += `  - \`${issue.filename}:${issue.line_number}\`\n\n`;
                });
              } else {
                comment += '### âœ… No Security Issues\n\n';
              }
            }
            
            comment += '### ðŸ“‹ Review Checklist\n';
            comment += '- [ ] All validation checks passed\n';
            comment += '- [ ] Code follows style guidelines\n';
            comment += '- [ ] Tests are passing\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true
      
      - name: Summary
        if: always()
        run: |
          echo "### PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some checks failed." >> $GITHUB_STEP_SUMMARY
          fi
