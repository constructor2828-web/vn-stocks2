name: Validate Code

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8
      
      - name: Lint with flake8
        run: |
          # Stop build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings (for now)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
      
      - name: Check import structure
        run: |
          python -c "
          import sys
          import importlib.util
          
          modules = [
              'bot', 'config', 'database', 'market', 
              'market_simulator', 'team_detection', 'utils'
          ]
          
          for module in modules:
              spec = importlib.util.find_spec(module)
              if spec is None:
                  print(f'ERROR: Cannot import {module}')
                  sys.exit(1)
              print(f'✓ {module} imports successfully')
          
          print('All modules import successfully!')
          "
      
      - name: Validate configuration
        run: |
          python -c "
          import config
          
          # Check required config values exist
          required = ['TEAMS', 'TEAM_TAGS', 'SPURS_PER_COG', 'MARKET_UPDATE_INTERVAL']
          for attr in required:
              assert hasattr(config, attr), f'Missing config: {attr}'
              print(f'✓ config.{attr} exists')
          
          # Validate TEAMS structure
          assert len(config.TEAMS) > 0, 'No teams defined'
          for symbol, team in config.TEAMS.items():
              required_keys = ['name', 'symbol', 'starting_price', 'volatility', 'role_name']
              for key in required_keys:
                  assert key in team, f'Team {symbol} missing key: {key}'
          
          print(f'✓ All {len(config.TEAMS)} teams properly configured')
          print('Configuration validation passed!')
          "
      
      - name: Summary
        if: always()
        run: |
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi
