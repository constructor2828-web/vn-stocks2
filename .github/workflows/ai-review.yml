name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    name: Gemini AI Review
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: pr-diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff_size=${#DIFF}" >> $GITHUB_OUTPUT
          
          # Save diff to file (truncate if too large)
          if [ ${#DIFF} -gt 50000 ]; then
            echo "$DIFF" | head -c 50000 > pr_diff.txt
            echo "âš ï¸ Diff truncated to 50KB" >> pr_diff.txt
          else
            echo "$DIFF" > pr_diff.txt
          fi
      
      - name: Get PR metadata
        id: pr-info
        uses: actions/github-script@v6
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const fileList = files.map(f => `${f.filename} (+${f.additions}/-${f.deletions})`).join('\n');
            
            return {
              title: pr.title,
              description: pr.body || 'No description provided',
              files: fileList,
              additions: pr.additions,
              deletions: pr.deletions
            };
      
      - name: AI Code Review with Gemini
        id: ai-review
        run: |
          PR_INFO='${{ steps.pr-info.outputs.result }}'
          PR_DIFF=$(cat pr_diff.txt)
          
          # Extract PR details
          TITLE=$(echo "$PR_INFO" | jq -r '.title')
          DESC=$(echo "$PR_INFO" | jq -r '.description')
          FILES=$(echo "$PR_INFO" | jq -r '.files')
          ADDITIONS=$(echo "$PR_INFO" | jq -r '.additions')
          DELETIONS=$(echo "$PR_INFO" | jq -r '.deletions')
          
          # Create prompt for Gemini
          cat > prompt.txt << 'PROMPT'
          You are an expert code reviewer for a Discord bot project written in Python. Review this pull request and provide:

          1. **Summary** (2-3 sentences): What does this PR do?
          2. **Key Changes**: Bullet list of main changes
          3. **Security Concerns**: Any security issues or vulnerabilities (or "None found")
          4. **Code Quality**: Issues with code style, complexity, or maintainability
          5. **Suggestions**: Specific improvements (with line numbers if possible)
          6. **Overall Assessment**: APPROVE, REQUEST_CHANGES, or COMMENT with reasoning

          Be concise, practical, and focus on issues that matter. Format your response in markdown.

          PR Title: ${TITLE}
          Description: ${DESC}

          Files Changed (${ADDITIONS} additions, ${DELETIONS} deletions):
          ${FILES}

          Diff:
          PROMPT
          
          cat prompt.txt pr_diff.txt > full_prompt.txt
          
          # Call Gemini API
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent" \
            -H "x-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "contents": [{
              "parts": [{
                "text": $(jq -Rs . < full_prompt.txt)
              }]
            }],
            "generationConfig": {
              "temperature": 0.3,
              "maxOutputTokens": 2048
            }
          }
          EOF
          )
          
          # Extract review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Failed to generate review"')
          
          # Save to file for next step
          echo "$REVIEW" > ai_review.txt
          
          # Check if review was successful
          if echo "$REVIEW" | grep -q "Failed to generate"; then
            echo "ERROR: Gemini API call failed"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "âœ“ AI review generated successfully"
      
      - name: Post AI Review Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('ai_review.txt', 'utf8');
            
            const comment = `## ðŸ¤– AI Code Review (Gemini)
            
            ${review}
            
            ---
            *This review was generated by Google Gemini. Please use human judgment for final decisions.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            console.log('âœ“ AI review posted to PR');
      
      - name: Upload review artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ai-review
          path: ai_review.txt
